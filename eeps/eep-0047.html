<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://beta.erlang.org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0047 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0047 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://beta.erlang.org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://beta.erlang.org/blog.xml" />
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/"><img
                    src="/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="get" action="https://duckduckgo.com/">
                    <input type="hidden" name="sites" value="erlang.org">
                    <input class="form-control me-2" id="searchfield" name="q" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Bj√∂rn Gustavsson &lt;bjorn(at)erlang(dot)org&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Final/21.0 Proposal is to be included in OTP release 21.0</dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>23-Nov-2017</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>21</dd>
                        
                        
                        <dt>Post-History:</dt>
                        <dd>24-Nov-2017, 30-Nov-2017</dd>
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                
                <h2 id="eep-47-add-syntax-in-trycatch-to-retrieve-the-stacktrace-directly">
        
        
          EEP 47: Add syntax in try/catch to retrieve the stacktrace directly <a href="#eep-47-add-syntax-in-trycatch-to-retrieve-the-stacktrace-directly">#</a>
        
        
      </h2>
    
      <h1 id="abstract">
        
        
          Abstract <a href="#abstract">#</a>
        
        
      </h1>
    

<p>This EEP proposes an extension to the <code>try/catch</code> statement to allow
the call stack back-trace (<strong>stacktrace</strong>) to be retrieved without
calling <code>erlang:get_stacktrace/0</code>.</p>
      <h1 id="specification">
        
        
          Specification <a href="#specification">#</a>
        
        
      </h1>
    

<p>We will introduce new syntax to retrieve the call stack back-trace
(hereafter called <strong>stacktrace</strong>).  Currently,
<code>erlang:get_stacktrace/0</code> can be called at any time to retrieve the
stacktrace from the last exception that occurred in the current
process.</p>

<p>The current syntax for <code>try/catch</code> is:</p>

<pre><code class="language-erlang">try
  Exprs
catch
    [Class1:]ExceptionPattern1 [when ExceptionGuardSeq1] -&gt;
        ExceptionBody1;
    [ClassN:]ExceptionPatternN [when ExceptionGuardSeqN] -&gt;
        ExceptionBodyN
end
</code></pre>

<p>We propose the following extension of the syntax for exception clause
heads:</p>

<pre><code class="language-erlang">Class:ExceptionPattern:Stacktrace [when ExceptionGuardSeq] -&gt;
</code></pre>

<p><code>Stacktrace</code> must be a variable name, not a pattern.  Furthermore,
<code>Stacktrace</code> must not be previously bound and it must not be
referenced in <code>ExceptionGuardSeq</code>.</p>

<p>Here is an example:</p>

<pre><code class="language-erlang">try
  Exprs
catch
  something_was_thrown -&gt;
    %% The default class is 'throw'.
    .
    .
    .
  throw:something_else_was_thrown -&gt;
    .
    .
    .
  throw:thrown_with_interesting_stacktrace:Stk -&gt;
    %% The class 'throw' must be explicitly given when
    %% the stacktrace is to be retrieved.
    .
    .
    .
  error:undef -&gt;
    %% Handle an undefined function specially.
    .
    .
    .
  C:E:Stk -&gt;
    %% Log any other exception and rethrow it.
    log_exception(C, E, Stk),
    raise(C, E, Stk)
end.
</code></pre>
      <h1 id="motivation">
        
        
          Motivation <a href="#motivation">#</a>
        
        
      </h1>
    

<p>The main motivation for this feature is to be able to deprecate
(and ultimately remove) <code>erlang:get_stacktrace/0</code>.</p>

<p>The problem with <code>erlang:get_stacktrace/0</code> is that it forces the
stacktrace from the latest exception in a process to be retained
until another exception occurs or the process terminates.  The
stacktrace often includes the arguments for the last function
call, BIF call, or (in OTP 21) operator that failed.  The arguments
can be of any size.</p>

<p>Here is an example:</p>

<pre><code class="language-erlang">1&gt; catch abs(lists:seq(1, 1000)).
{'EXIT',{badarg,
      [{erlang,abs,
                 [[1,2,3,4,5,6,7,8,9,10,11,12,13,
                   14,15,16,17,18,19,20|...]],
                 []},
          {erl_eval,do_apply,6,[{file,"erl_eval.erl"},{line,674}]},
          {erl_eval,expr,5,[{file,"erl_eval.erl"},{line,431}]},
          {shell,exprs,7,[{file,"shell.erl"},{line,687}]},
          {shell,eval_exprs,7,[{file,"shell.erl"},{line,642}]},
          {shell,eval_loop,3,[{file,"shell.erl"},{line,627}]}]}}
2&gt;
</code></pre>

<p>The list containing the integers from 1 through 1000 will be kept
in the process that caused the exception until another exception
occurs in the same process.</p>

<p>In a future release, where <code>erlang:get_stacktrace/0</code> has either been
changed to always return <code>[]</code> or been removed, it is no longer
necessary to keep the stacktrace in the process indefinitely.</p>

<p>Another motivation is that pitfalls such as the one in the following
example are impossible:</p>

<pre><code class="language-erlang">try
  Expr
catch
  C:E -&gt;
    do_something(),
    log_exception(C, E, erlang:get_stacktrace())
end
</code></pre>

<p>If <code>do_something()</code> generates and catches an exception, the call
to <code>erlang:get_stacktrace/0</code> will retrieve the wrong stacktrace.</p>
      <h1 id="rationale">
        
        
          Rationale <a href="#rationale">#</a>
        
        
      </h1>
    
      <h2 id="the-syntax">
        
        
          The Syntax <a href="#the-syntax">#</a>
        
        
      </h2>
    

<p>Regarding the syntax, we did consider using another token instead of
colon before the stacktrace variable.  That would continue to allow
making the class <code>throw</code> implicit even when retrieving the stacktrace.
That is, you could write an exception pattern, followed by some
special token, followed by the name of the stacktrace variable, and
the class <code>throw</code> would be implicitly understood.</p>

<p>We rejected that for two reasons:</p>

<ul>
  <li>
    <p>We could not find a suitable separator token.  Our best suggestion
was <code>@</code>, and that will not work because <code>@</code> is allowed in atoms.
Tokens like <code>/</code> could confuse at least the parser (and possibly human
readers) because patterns are allowed to contain constant expressions.
A double colon (<code>::</code>) would not cause any ambiguitiy issues, but
everyone immediately associated it with a type declaration.</p>
  </li>
  <li>
    <p>In practice, when catching an exception of class <code>throw</code>, one is
almost never interested in the stacktrace.</p>
  </li>
</ul>
      <h2 id="why-not-allow-matching-on-the-stacktrace">
        
        
          Why Not Allow Matching On The Stacktrace? <a href="#why-not-allow-matching-on-the-stacktrace">#</a>
        
        
      </h2>
    

<p><code>Stacktrace</code> must be a variable, not a pattern.  There are two
reasons:</p>

<ul>
  <li>
    <p>In general, pattern matching on the stacktrace is discouraged.  The
intention is that it should be inspected by a human to aid in
debugging.</p>
  </li>
  <li>
    <p>Allowing pattern matching on the stacktrace would be expensive.
When an exception occurs, a raw stacktrace is saved.  The raw
stacktrace contains a limited number of continuation pointers
(by default 8) collected from the stack and possibly the arguments
for the function call or BIF call that failed.  To convert the
raw stacktrace to the symbolic form that can be matched or shown is
quite expensive; by only allowing a variable, that conversion will
only happen when a clause has matched and its body is about to
be executed.</p>
  </li>
</ul>
      <h2 id="limiting-the-scope-of-erlangget_stacktrace0-instead">
        
        
          Limiting The Scope Of erlang:get_stacktrace/0 Instead? <a href="#limiting-the-scope-of-erlangget_stacktrace0-instead">#</a>
        
        
      </h2>
    

<p>In OTP 20, we introduced a new warning in the documentation for
<code>erlang:get_stacktrace/0</code>:</p>

<blockquote class='blockquote'>
  <p><code>erlang:get_stacktrace/0</code> is only guaranteed to return a stacktrace if
  called (directly or indirectly) from within the scope of a try
  expression.</p>
</blockquote>

<p>Our intention was that by limiting the scope, the stacktrace could be
cleared when exiting the scope.  For example, the following code would
continue to work, but the stacktrace would be cleared when leaving
<code>try/catch</code>:</p>

<pre><code class="language-erlang">try Expr
catch
  C:R -&gt;
   {C,R,helper()}
end

helper() -&gt;
  erlang:get_stacktrace().
</code></pre>

<p>Unfortunately, the following slightly different example would force
a hard choice upon us:</p>

<pre><code class="language-erlang">try Expr
catch
  C:R -&gt;
   helper(C, R)
end

helper(C, R) -&gt;
  {C,R,erlang:get_stacktrace()}.
</code></pre>

<p>The call to <code>helper/2</code> is tail-recursive.  If we are to keep the call
tail-recursive, we cannot clear the stacktrace.  Conversely, if we are
to clear the stacktrace, the call can no longer be tail-recursive.</p>

<p>Another problem is that the compiler cannot warn for all instances of
calls to <code>erlang:get_stacktrace/0</code> that would not return a stacktrace.
All it can do is to warn for obvious calls that will not work such as
in the following example:</p>

<pre><code class="language-erlang">try Expr
catch
  C:R -&gt;
    .
    .
    .
end,
Stk = erlang:get_stacktrace(),
.
.
.
</code></pre>

<p>That is, the compiler can only warn if there is a use of <code>try/catch</code>
or <code>catch</code> followed by a call to <code>erlang:get_stacktrace/0</code> in the same
function.</p>

<p>We could limit the useful scope of <code>erlang:get_stacktrace/0</code> to
just the syntactic scope of the clause within the <code>try/catch</code>.
For example:</p>

<pre><code class="language-erlang">try
  Expr
catch
  C:E -&gt;
    Stk = erlang:get_stacktrace(),
    log_exception(C, E, Stk)
end
</code></pre>

<p>It does not seem to be any advantage of that solution compared
to introducing the new syntax.  Developers would still have to
update their programs (eliminating calls to <code>erlang:get_stacktrace/0</code>
from helper functions and moving them into the syntactic scope of
the <code>try/catch</code>).</p>
      <h1 id="backwards-compatibility">
        
        
          Backwards Compatibility <a href="#backwards-compatibility">#</a>
        
        
      </h1>
    

<p>Since the new syntax would cause a compilation error in OTP 20
and previous releases, no existing source code can be affected.</p>

<p>The abstract format already includes a variable (with the name <code>_</code>)
for the stacktrace in exception clauses.  That means that many
tools that manipulate the abstract Erlang code will continue to
work without any change.</p>

<p>The <code>erlang:get_stacktrace/0</code> BIF can be deprecated in several
stages to minimize the impact of the change.</p>

<p>For example:</p>

<ul>
  <li>
    <p>In OTP 21, there will be a compiler warning that
<code>erlang:get_stacktrace/0</code> is deprecated.</p>
  </li>
  <li>
    <p>In OTP 23 (or possibly OTP 22), <code>erlang:get_stacktrace/0</code> will start
returning <code>[]</code>.  Many programs that have not been updated will
continue to work, except that if an exception is raised no stacktrace
will be available to aid in debugging.</p>
  </li>
  <li>
    <p>In some future release (OTP 42?), <code>erlang:get_stacktrace/0</code> can be
removed.</p>
  </li>
</ul>
      <h1 id="implementation">
        
        
          Implementation <a href="#implementation">#</a>
        
        
      </h1>
    

<p>The implementation can be found in <a href="https://github.com/erlang/otp/pull/1634" title="#1634: Add syntax in try/catch to retrieve the stacktrace directly">PR #1634</a>.</p>
      <h1 id="copyright">
        
        
          Copyright <a href="#copyright">#</a>
        
        
      </h1>
    

<p>This document has been placed in the public domain.</p>

            </div>
        </div>
    </div>
</div>
<script src="/assets/js/prismjs/prism.js"></script>
<script src="/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/downloads.html" title="DOWNLOAD"><img src="/assets/img/download.png" alt="Download Erlang/OTP"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/assets/img/GitHub-Mark-32px.png" alt="Erlang/OTP on Github"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/assets/img/twitter.png"
                    width="32" alt="Erlang/OTP twitter"></a>
        </div>
    </footer>
    <script src="/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>