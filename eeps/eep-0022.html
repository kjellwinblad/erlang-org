<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://beta.erlang.org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Eep 0022 - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Eep 0022 - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://beta.erlang.org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://beta.erlang.org/blog.xml" />
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/"><img
                    src="/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="get" action="https://duckduckgo.com/">
                    <input type="hidden" name="sites" value="erlang.org">
                    <input class="form-control me-2" id="searchfield" name="q" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-10 offset-lg-1">
            <div class="card">
                <div class="card-body">
                    <dl class="mb-0 dl-single">
                        <dt>Author:</dt>
                        <dd>
                            Richard A. O&#39;Keefe &lt;ok(at)cs(dot)otago(dot)ac(dot)nz&gt;
                            
                            
                        </dd>
                        
                        <dt>Status:</dt>
                        <dd>Draft </dd>
                        <dt>Type:</dt>
                        <dd>Standards Track</dd>
                        
                        
                        <dt>Created:</dt>
                        <dd>27-Aug-2008</dd>
                        
                        <dt>Erlang-Version:</dt>
                        <dd>R12B-4</dd>
                        
                        
                        
                        
                    </dl>
                </div>
            </div>
            <div class="border-top mt-4">
                
                <h2 id="eep-22-range-checking-for-binaries">
        
        
          EEP 22: Range checking for binaries <a href="#eep-22-range-checking-for-binaries">#</a>
        
        
      </h2>
    
      <h1 id="abstract">
        
        
          Abstract <a href="#abstract">#</a>
        
        
      </h1>
    

<p>A module may request that bit fields be range checked.</p>
      <h1 id="specification">
        
        
          Specification <a href="#specification">#</a>
        
        
      </h1>
    

<p>A new directive is added.</p>

<pre><code class="language-erlang">-bit_range_check(Wanted).
</code></pre>

<p>where Wanted is ‘false’ or ‘true’.</p>

<p>Recall that a segment of a bit string (or binary) has the form</p>

<pre><code class="language-erlang">Value [':' Size] ['/' Type_Specifier_List]
</code></pre>

<p>where <code>Type_Specifier_List</code> includes such things as ‘integer’,
‘signed’, and ‘unsigned’.  Currently the documentation states
that</p>

<pre><code class="language-erlang">"Signedness ... Only matters for matching and when the type
 is integer.  The default is unsigned."
</code></pre>

<p>Combining the <code>Size</code> with the <code>Unit</code> gives a <code>Size_In_Bits</code>.
The on-line Erlang manual does not state in section 6.16 that
in constructing a bit string the bottom <code>Size_In_Bits</code> bits of
an integer are used with the rest quietly ignored, but it is so.</p>

<p>The directive <code>-bit_range_check(false)</code> makes explicit the
programmer’s intention that this C-like truncation should happen.</p>

<p>The directive <code>-bit_range_check(true)</code> says that it is a checked
run-time error in</p>

<pre><code class="language-erlang">Value:Size/unsigned-integer-unit:1
</code></pre>

<p>or constructions otherwise equivalent to it if Value does not
lie in the range <code>0 &lt;= Value &lt; 2**Size</code>, and it is a checked
run-time error in</p>

<pre><code class="language-erlang">Value:Size/signed-integer-unit:1
</code></pre>

<p>or constructions otherwise equivalent to it if Value does not
lie in the range <code>-(2**(Size-1)) &lt;= Value &lt; 2**(Size-1)</code>.</p>

<p>The error that is raised is like the error that would be raised
for <code>(1//0):Size/Type_Specifier_List</code> except for using ‘badrange’
instead of ‘badarith’.</p>

<p>The behaviour of integer bit syntax segments in the absence of
a <code>-bit_range_check</code> directive is implementation defined and
subject to change.</p>

<p>The BEAM system is extended with a new instruction or instructions
similar to the existing instruction or instructions for integer
segments but checking the range.  The compiler is extended to
generate them for <code>&lt;&lt;...&gt;&gt;</code> expressions in the range of a
<code>-bit_range_check(true)</code> directive.</p>

<p>A <code>-bit_range_check</code> directive may not appear after a bit syntax
pattern or expression or after another <code>-bit_range_check</code> directive.</p>
      <h1 id="motivation">
        
        
          Motivation <a href="#motivation">#</a>
        
        
      </h1>
    

<p>It keeps on coming as an unpleasant surprise to Erlang programmers
that this truncation happens.  Quiet destruction of information is
otherwise alien to Erlang:  integer arithmetic is unbounded, not
wrapped as in some (but not all) C systems; element/2 doesn’t take
indices modulo tuple size but raises an exception if the index is
out of range, and so on.</p>

<p>In any case where the truncation is wanted, an Erlang programmer
can already write</p>

<pre><code class="language-erlang">(Value rem 256):unsigned-integer
</code></pre>

<p>and the Erlang compiler could notice this and optimise the ‘rem’
operation away, so the truncation is not only unusual in Erlang,
it is also unexpected in this particular case.</p>

<p>It is not only unexpected, it removes a chance to find mistakes,
so it would seem to be undesirable.</p>

<p>Edwin Fine asked “How difficult could it be to add optional run-
time checking to detect this condition without a serious risk of
adverse effects on the correctness of Erlang run-time execution?”</p>

<p>Björn Gustavsson replied “it would be better to add optional
support in the compiler to turn on checks (either for an entire
module, or for individual segments of a binary).  If someone
writes an EEP, we will consider implementing it.”</p>

<p>This is that EEP.</p>
      <h1 id="rationale">
        
        
          Rationale <a href="#rationale">#</a>
        
        
      </h1>
    

<p>The Erlang/OTP team regard the old behaviour as a feature,
and wish to retain it.  In particular, they wish modules that
were written expecting the old behaviour to continue to work
(for now) without modification.</p>

<p>One alternative would be to add new syntax, such as having a
new ‘checked’ specifier, so that</p>

<pre><code class="language-erlang">Value/checked-unsigned-integer
</code></pre>

<p>would require a value in the range 0..255.
But many Erlang programmers will want to use this as the normal
case, and will not like the safe version being so much more effort
to write than the unsafe version.</p>

<p>It appears that “truncation wanted/not wanted” is not a matter
of this expression or that, but of this programmer or that,
and we can expect that each module will be written by someone
expecting only one behaviour or expecting only the other.</p>

<p>Adding a</p>

<pre><code class="language-erlang">-bit_range_check(true).
</code></pre>

<p>directive to a module is more work than doing nothing at all,
but programmers who want this behaviour should be able to set up
their editing environment to have this line in their template for
creating new Erlang modules.</p>

<p>There are several questions:</p>

<ul>
  <li>Should this apply to bit strings as well as integers?</li>
  <li>What should the name of the directive be?</li>
  <li>What should the argument(s) of the directive be?</li>
  <li>Should multiple instances of the directive be allowed in
a module?</li>
</ul>

<p>Bit strings:  <code>Assume X = &lt;&lt;5:3/unsigned-integer-unit:1&gt;&gt;</code>.
Currently, <code>&lt;&lt;X:2/bits&gt;&gt;</code> quietly truncates <code>X</code>.  This drops bits
from the right of <code>X</code>, giving <code>&lt;&lt;2:2&gt;&gt;</code>.  If this worked the same
as integers, you would expect <code>&lt;&lt;1:2&gt;&gt;</code>.  This is certainly
very odd.  Since we get truncation on the left and padding on
the left for integers, we naturally expect padding on the
right for bit strings to go with truncation on the right.
But <code>&lt;&lt;X:4/bits&gt;&gt;</code> isn’t <code>&lt;&lt;10:4&gt;&gt;</code>, it’s a runtime exception.
All very odd indeed.  It would certainly be desirable to have
an easy way for the programmer to indicate whether they wanted
truncation on the left or the right and padding on the left or
the right.  Perhaps a new built in function</p>

<pre><code class="language-erlang">set_bit_size(Bit_String, Desired_Width,
             Truncation, Padding, Fill)

Bit_String : a bit string
Desired_Width : a non-negative integer, the width wanted
Truncation: 'left' | 'right' | 'error';
    if bit_size(Bit_String) &gt; Desired_Width
        truncate on the left/truncate on the right/
        report an error
Padding: 'left' | 'right' | 'error';
    if bit_size(Bit_String) &lt; Desired_Width
        pad on the left/pad on the right/report an error
Fill: 0 | 1 | 'copy';
    pad with 0/pad with 1/pad with a copy of the
    last bit at the end where padding is done.
</code></pre>

<p>However, that idea is only partly baked, and is not part of the
current proposal.  As things currently stand, using the bit
syntax and relying on implicit truncation is the simplest way
to extract the leading bits of a bit string.</p>

<p>As long as the name of the directive is intention-revealing,
it doesn’t matter very much what it is.
I proposed <code>bit_range_check</code> because it is all about checking,
ranges in bit syntax, but since in this draft it does NOT apply
to bit string segments, perhaps <code>bit_integer_range_check</code> would
be better.</p>

<p>The arguments false and true seem clear enough.
Alternatives would be something like</p>

<pre><code class="language-erlang">-bit_integer_range(check).
-bit_integer_range(no_check).
</code></pre>

<p>That would be fine too.</p>

<p>Classical Pascal compilers let you do things like</p>

<pre><code class="language-erlang">{$I-}   (* disable index checks *)
(* code with no index checks *)
{$I+}   (* re-enable index checks *)
</code></pre>

<p>Allowing multiple <code>-bit_range_check</code> directives in a module could
let you use code written for the old approach inside a module
that otherwise uses the new approach.  I don’t believe that we
want to encourage that sort of thing:  it is MUCH easier when
reading a module if all of it follows the same rule.</p>

<p>It is also easier for an Erlang compiler that expects to be able
to process function definitions in any order.  The compiler can
check for one of these directives anywhere in a module before it
handles any bit syntax forms anywhere.  However, it is easier for
people reading a module if, when they first see a <code>&lt;&lt;...&gt;&gt;</code>
construction, they have already seen any directive that might
affect what it means.</p>

<p>The restrictions on the number and placement of these directives
can always be relaxed later if necessary.</p>
      <h1 id="backwards-compatibility">
        
        
          Backwards Compatibility <a href="#backwards-compatibility">#</a>
        
        
      </h1>
    

<p>All existing Erlang code remains acceptable with unchanged semantics.</p>
      <h1 id="reference-implementation">
        
        
          Reference Implementation <a href="#reference-implementation">#</a>
        
        
      </h1>
    

<p>None, because I still can’t find my way around the compiler.</p>
      <h1 id="copyright">
        
        
          Copyright <a href="#copyright">#</a>
        
        
      </h1>
    

<p>This document has been placed in the public domain.</p>

            </div>
        </div>
    </div>
</div>
<script src="/assets/js/prismjs/prism.js"></script>
<script src="/assets/js/prismjs/components/prism-erlang.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/downloads.html" title="DOWNLOAD"><img src="/assets/img/download.png" alt="Download Erlang/OTP"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/assets/img/GitHub-Mark-32px.png" alt="Erlang/OTP on Github"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/assets/img/twitter.png"
                    width="32" alt="Erlang/OTP twitter"></a>
        </div>
    </footer>
    <script src="/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>