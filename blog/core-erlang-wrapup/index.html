<!DOCTYPE html>
<html lang="en">



<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <!-- Allow pinning of website on windows -->
    <meta name="application-name" content="Erlang.org">
    <meta name="msapplication-tooltip" content="The official home of the Erlang Programming Language">
    <meta name="msapplication-starturl" content="/" >

    <!-- Make the site look nicer on facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Erlang.org">
    <meta property="og:title" content="Welcome to Erlang.org">
    <meta property="og:description" content="The official home of the Erlang Programming Language">
    <meta property="og:image" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:image:secure_url" content="https://beta.erlang.org/assets/img/erlang-228x200.png">
    <meta property="og:url" content="https://beta.erlang.org/">

    <!-- Twitter metadata -->
    <meta name="twitter:card" content="summary" />
    <meta property="twitter:title" content="Index" />
    <meta name="twitter:site" content="@erlang_org" />

    <!-- Rich data for google search -->
    <script type="application/ld+json">
{"@type":"WebSite","url":"https://erlang.org/","headline":"Core Erlang Wrap Up - Erlang/OTP","name":"Erlang.org","sameAs":["https://twitter.com/erlang_org","https://github.com/erlang/otp"],"@context":"https://schema.org"}</script>

    <title>Core Erlang Wrap Up - Erlang/OTP</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- tells iOS browsers to not show telephone numbers as links -->
    <meta name="format-detection" content="telephone=no">

    <meta name="application-name" content="Erlang.org">
    <meta name="description" content="The official home of the Erlang Programming Language">
    <meta name="keywords" content="Erlang programming language functional parallel distributed documentation download community">
    <!-- https://www.rssboard.org/rss-autodiscovery -->
    <link rel="alternate" type="application/atom+xml" title="News Atom Feed" href="https://beta.erlang.org/news.xml" />
    <link rel="alternate" type="application/atom+xml" title="Blog Atom Feed" href="https://beta.erlang.org/blog.xml" />
    
    <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>
    <header class="navbar navbar-expand-lg navbar-light bg-body">
        <nav class="container">
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <a class="navbar-brand" href="/"><img
                    src="/assets/img/erlang.png" class="img-fluid" width="60" alt="Erlang.org main page"/></a>
            <div class="collapse navbar-collapse fw-bold" id="navbarSupportedContent">
                <ul class="navbar-nav text-uppercase me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" href="/downloads">Download</a></li>
                    <li class="nav-item"><a class="nav-link" href="/docs">Documentation</a></li>
                    <li class="nav-item"><a class="nav-link" href="/community">Community</a></li>
                    <li class="nav-item"><a class="nav-link" href="/news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link" href="/eep">EEP</a></li>
                    <li class="nav-item"><a class="nav-link" href="/about">About</a></li>
                </ul>
                <form class="d-flex" role="search" method="get" action="https://duckduckgo.com/">
                    <input type="hidden" name="sites" value="erlang.org">
                    <input class="form-control me-2" id="searchfield" name="q" type="search" placeholder="Search erlang.org"
                        aria-label="Search">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        </nav>
    </header>
    <div class="container border-top pt-4">
    <div class="row-lg">
        <div class="col-lg-8 offset-lg-2">
            <article class="card mb-4">
    <div class="card-header">
        <h3><a href="/blog/core-erlang-wrapup/">Core Erlang Wrap Up</a></h3>
        <div class="date">May 30, 2018
             · by Björn Gustavsson
        </div>
    </div>

    <div class="card-body">
        
        
        
        <p>This blog post wraps up the exploration of Core Erlang started in the
previous two blog posts. The remaining default Core Erlang
passes are described, followed by a look at how Core Erlang is
represented internally in the compiler.</p>

<p>Here are the Core Erlang passes that will be run when using
OTP 21 RC1 or the <code>master</code> branch in the git repository:</p>

<pre><code>$ erlc +time core_wrapup.erl
Compiling "core_wrapup"
     .
     .
     .
 core                          :      0.000 s      15.7 kB
 sys_core_fold                 :      0.000 s       9.0 kB
 sys_core_alias                :      0.000 s       9.0 kB
 core_transforms               :      0.000 s       9.0 kB
 sys_core_bsm                  :      0.000 s       9.0 kB
 sys_core_dsetel               :      0.000 s       9.0 kB
     .
     .
     .
</code></pre>

<p>We have covered <code>core</code> and <code>sys_core_fold</code> in the two previous
blog posts about Core Erlang.</p>
      <h2 id="the-other-core-erlang-passes">
        
        
          The other Core Erlang passes <a href="#the-other-core-erlang-passes">#</a>
        
        
      </h2>
    
      <h3 id="sys_core_alias">
        
        
          sys_core_alias <a href="#sys_core_alias">#</a>
        
        
      </h3>
    

<p>In the upcoming OTP 21 release, there is a new <code>sys_core_alias</code> pass
contributed by <a href="https://github.com/josevalim">José Valim</a>.</p>

<p>The purpose of the pass is to avoid rebuilding terms that
have been matched, such as in this example:</p>

<pre><code class="language-erlang">remove_even([{Key,Val}|T]) -&gt;
    case Val rem 2 =:= 0 of
        true -&gt; remove_even(T);
        false -&gt;  [{Key,Val}|remove_even(T)]
    end;
remove_even([]) -&gt; [].
</code></pre>

<p>In the function head, the pattern <code>{Key,Val}</code> binds two elements of a
tuple to the variables <code>Key</code> and <code>Val</code>, but the original tuple is not
captured. In the <code>false</code> clause of the <code>case</code>, a new tuple will be
constructed from <code>Key</code> and <code>Val</code>.</p>

<p>It is possible to avoid creating a new tuple by using the <code>=</code> operator
to bind the complete tuple to a variable:</p>

<pre><code class="language-erlang">remove_even([{Key,Val}=Tuple|T]) -&gt;
    case Val rem 2 =:= 0 of
        true -&gt; remove_even(T);
        false -&gt;  [Tuple|remove_even(T)]
    end;
remove_even([]) -&gt; [].
</code></pre>

<p>Essentially, the new <code>sys_core_alias</code> pass does that transformation
automatically. Here is the Core Erlang code before applying this
optimization:</p>

<pre><code>'remove_even'/1 =
    fun (_0) -&gt;
	case _0 of
	  &lt;[{Key,Val}|T]&gt; when 'true' -&gt;
	      let &lt;_1&gt; =
		  call
		       'erlang':'rem'(Val, 2)
	      in
		  case &lt;&gt; of
		    &lt;&gt;
			when call 'erlang':'=:='(_1, 0) -&gt;
			    apply 'remove_even'/1(T)
		    &lt;&gt; when 'true' -&gt;
			let &lt;_2&gt; =
			    apply 'remove_even'/1(T)
			in
                            [{Key,Val}|_2]      % BUILDING TUPLE
		  end
	  &lt;[]&gt; when 'true' -&gt;
	      []
	  &lt;_4&gt; when 'true' -&gt;
		primop 'match_fail'({'function_clause',_4})
	end
</code></pre>

<p>Here is the code after running the <code>sys_core_alias</code> pass:</p>

<pre><code>'remove_even'/1 =
    fun (_0) -&gt;
	case _0 of
	  &lt;[_@r0 = {Key,Val}|T]&gt; when 'true' -&gt;
	      let &lt;_1&gt; =
		  call 'erlang':'rem'(Val, 2)
	      in
		  case &lt;&gt; of
		    &lt;&gt;
			when call 'erlang':'=:='(_1, 0) -&gt;
			    apply 'remove_even'/1(T)
		    &lt;&gt; when 'true' -&gt;
			let &lt;_2&gt; =
			    apply 'remove_even'/1(T)
			in
			    [_@r0|_2]          % REUSING EXISTING TUPLE
		  end
	  &lt;[]&gt; when 'true' -&gt;
	      []
	  &lt;_4&gt; when 'true' -&gt;
		primop 'match_fail'({'function_clause',_4})
	end
</code></pre>
      <h3 id="core_transforms">
        
        
          core_transforms <a href="#core_transforms">#</a>
        
        
      </h3>
    

<p>Similar to parse transforms, the <code>core_transforms</code> pass makes it possible to
add compiler passes that transform the Core Erlang code without modifying
the compiler.</p>

<p>As an example, here is a simple core transform module:</p>

<pre><code class="language-erlang">-module(my_core_transform).
-export([core_transform/2]).

core_transform(Core, _Options) -&gt;
    Module = cerl:concrete(cerl:module_name(Core)),
    io:format("Module name: ~p\n", [Module]),
    io:format("Number of nodes in Core Erlang tree: ~p\n",
              [cerl_trees:size(Core)]),
    Core.
</code></pre>

<p>Before explaining the code, let’s see it in action:</p>

<pre><code>$ erlc my_core_transform
$ erlc -pa . '+{core_transform,my_core_transform}' core_wrapup.erl
Module name: core_wrapup
Number of nodes in Core Erlang tree: 220
$
</code></pre>

<p>The <code>{core_transform,Name}</code> option instructs the compiler to run a
core transformation. In this case, the core transform module is
<code>my_core_transform</code>. After doing the standard optimizing passes,
the compiler will call <code>my_core_transform:core_transform/2</code>, passing
the Core Erlang code as the first argument and the compiler options
as the second argument.</p>

<p>The first line in the <code>core_transform/2</code> functions calls
<code>cerl:module_name(Core)</code> to retrieve the module name. The return value
of <code>cerl:module_name/1</code> is a record representing any literal term. To
retrieve the actual term (an atom in this case), <code>cerl:concrete/1</code>
is called.</p>

<p>In the second <code>io:format/2</code> call, we call <code>cerl_trees:size/1</code> to
count the number of nodes in the tree that represents the Core Erlang
code for the module.</p>

<p>This core transform does not do any real transforming, since the last
line returns the Core Erlang code without any modifications.</p>
      <h3 id="sys_core_bsm">
        
        
          sys_core_bsm <a href="#sys_core_bsm">#</a>
        
        
      </h3>
    

<p><code>sys_core_bsm</code> is the first of three passes that implement the delayed
sub binary optimization described in the <a href="http://erlang.org/doc/efficiency_guide/binaryhandling.html">Efficiency
Guide</a>.  <code>sys_core_bsm</code> adds annotations that are
later used by <code>v3_codegen</code> and <code>beam_bsm</code> to optimize matching of
binaries.</p>
      <h3 id="sys_core_dsetel">
        
        
          sys_core_dsetel <a href="#sys_core_dsetel">#</a>
        
        
      </h3>
    

<p>The <code>sys_core_dsetel</code> pass will optimize chained or nested
applications of <code>setelement/3</code> as in this example:</p>

<pre><code class="language-erlang">update_tuple(T0) -&gt;
    T = setelement(3, T0, y),
    setelement(2, T, x).
</code></pre>

<p>Translated to Core Erlang it looks like this:</p>

<pre><code>'update_tuple'/1 =
    fun (_0) -&gt;
	let &lt;T&gt; =
	    call 'erlang':'setelement'(3, _0, 'y')
	in
	    call 'erlang':'setelement'(2, T, 'x')
</code></pre>

<p>The <code>sys_core_dsetel</code> pass replaces the second call to <code>setelement/3</code>
with the primop <code>dsetelement/3</code>, which destructively updates a tuple:</p>

<pre><code>'update_tuple'/1 =
    fun (_0) -&gt;
	let &lt;T&gt; =
	    call 'erlang':'setelement'(3, _0, 'y')
	in  do
		primop 'dsetelement'(2, T, 'x')
		T
</code></pre>

<p><code>do</code> evalutes two expressions in sequence, ignoring the value of the
first expression. It is used here because the primop <code>dsetelement/3</code>
updates its tuple argument without returning a value.</p>

<p>The <code>sys_core_dsetel</code> pass is intentionally run as the very last
Core Erlang pass. Doing other optimizations might render the optimization
unsafe. For example, there must not occur a garbage collection between
the call to <code>setelement/3</code> and <code>dsetelement/3</code>.</p>

<p>Why is this optimization useful? Surely a sequence of <code>setelement/3</code>
calls must be rare?</p>

<p>Consider this function that updates two elements in a record:</p>

<pre><code>-record(rec, {a,b,c,d,e,f,g,h}).

update_record(R) -&gt;
    R#rec{a=x,b=y}.
</code></pre>

<p>In <a href="http://blog.erlang.org/compiler-lost-in-translation/">a previous blog post</a> we saw that the <code>-E</code> option
will produce an <code>.E</code> file with the code after records have been translated
to tuple operations:</p>

<pre><code>$ erlc -E core_wrapup.erl
</code></pre>

<p>Here is the code for <code>update_record/1</code> after record translation:</p>

<pre><code>update_record(R) -&gt;
    begin
        rec0 = R,
        case rec0 of
            {rec,_,_,_,_,_,_,_,_} -&gt;
                setelement(2, setelement(3, rec0, y), x);
            _ -&gt;
                error({badrecord,rec})
        end
    end.
</code></pre>

<p>After verifying that <code>R</code> is indeed a record of the correct type (that is,
that the size and first element of the tuple are correct), nested calls
to <code>setelement/3</code> is used to update two elements of the tuple.</p>

<p>The optimized Core Erlang code for <code>update_record/1</code> will look like
this:</p>

<pre><code>'update_record'/1 =
    fun (_0) -&gt;
	case _0 of
	  &lt;{'rec',_5,_6,_7,_8,_9,_10,_11,_12}&gt; when 'true' -&gt;
	      let &lt;_2&gt; =
		  call 'erlang':'setelement'(3, _0, 'y')
	      in  do  primop 'dsetelement'(2, _2, 'x')
		      _2
	  &lt;_13&gt; when 'true' -&gt;
		call 'erlang':'error'({'badrecord','rec'})
	end
</code></pre>
      <h2 id="the-representation-of-core-erlang-code">
        
        
          The representation of Core Erlang code <a href="#the-representation-of-core-erlang-code">#</a>
        
        
      </h2>
    

<p>So far we have looked at the external (pretty-printed) representation of
Core Erlang. Before leaving Core Erlang, we will take a brief look at
the internal representation of Core Erlang that the compiler uses.</p>

<p>There are <del>two</del> three ways to work with Core Erlang within an
optimizer pass:</p>

<ul>
  <li>
    <p>Using the API functions in the <code>cerl</code> module</p>
  </li>
  <li>
    <p>Using the <code>c_*</code> records defined in <code>core_parse.hrl</code></p>
  </li>
  <li>
    <p>Mixing use of records with use of the API functions</p>
  </li>
</ul>
      <h3 id="using-the-cerl-module-and-friends">
        
        
          Using the cerl module and friends <a href="#using-the-cerl-module-and-friends">#</a>
        
        
      </h3>
    

<p>The <code>cerl</code> module provides API functions to construct, deconstruct, update,
and query each of the constructs in Core Erlang.</p>

<p>Here are some examples:</p>

<ul>
  <li>
    <p><code>cerl:c_var(Name)</code> constructs the Core Erlang representation
of a variable with the name <code>Name</code>.</p>
  </li>
  <li>
    <p><code>cerl:is_c_var(Core)</code> returns <code>true</code> if the <code>Core</code> represents a Core
Erlang variable, and <code>false</code> otherwise.</p>
  </li>
  <li>
    <p><code>cerl:var_name(Core)</code> returns the name of a variable (and crashes if
<code>Core</code> does not represent a Core Erlang variable).</p>
  </li>
</ul>

<p>There are also the <code>cerl_trees</code> and <code>cerl_clauses</code> modules that provide
useful utility functions for manipulating Core Erlang code.</p>
      <h3 id="using-the-records">
        
        
          Using the records <a href="#using-the-records">#</a>
        
        
      </h3>
    

<p>In <code>core_parse.hrl</code>, there is one record for each kind of Core Erlang
construct. All record names start with the prefix <code>c_</code>.</p>

<p>For example, the record <code>#c_var{}</code> represents a variable, the record
<code>#c_call{}</code> the <code>call</code> expression, the record <code>c_tuple{}</code> a tuple, and
so on.</p>

<p>As a complete example, we can rewrite our previous core transform
to use record matching instead of <code>cerl</code> to retrieve the module name:</p>

<pre><code>-module(my_core_transform).
-export([core_transform/2]).

-include_lib("compiler/src/core_parse.hrl").

core_transform(Core, _Options) -&gt;
    #c_module{name=#c_literal{val=Module}} = Core,
    io:format("Module name: ~p\n", [Module]),
    io:format("Number of nodes in Core Erlang tree: ~p\n",
              [cerl_trees:size(Core)]),
    Core.
</code></pre>
      <h3 id="mixing-the-cerl-api-with-records">
        
        
          Mixing the <code>cerl</code> API with records <a href="#mixing-the-cerl-api-with-records">#</a>
        
        
      </h3>
    

<p>The <code>cerl</code> module internally use the records in <code>core_parse.hrl</code>, so
the two approaches can be mixed. For example, <code>sys_core_fold</code> mostly
use the records, but sometimes uses <code>cerl</code> when it is more convenient.</p>
      <h2 id="wrapping-up-the-wrap-up">
        
        
          Wrapping up the wrap up <a href="#wrapping-up-the-wrap-up">#</a>
        
        
      </h2>
    

<p>It seems that there is enough material for several more blog posts
about Core Erlang. For instance, I haven’t even mentioned the inliners
(not a typo, there are <em>two</em> inliners). That means that there might be
more blog posts about Core Erlang in the future.</p>

<p>But in the very near future, it is time to explore the compiler passes
that follow Core Erlang, and perhaps answer the eternal question about
the <code>v3_</code> prefix. Was there ever a <code>v2_kernel</code> (spoiler: yes) or a
<code>v1_kernel</code> (spoiler: no)?</p>

        
    </div>
</article>
        </div>
    </div>
</div>
<script src="/assets/js/prismjs/prism.js"></script>
<script src="/assets/js/prismjs/components/prism-erlang.js"></script>
<script src="/assets/js/prismjs/components/prism-c.js"></script>
<script src="/assets/js/prismjs/components/prism-bash.js"></script>
    <footer class="container-fluid footer text-center border-top border-bottom">
        <div>
            <a href="/downloads.html" title="DOWNLOAD"><img src="/assets/img/download.png" alt="Download Erlang/OTP"></a>
        </div>
        <div>
            <a href="http://www.github.com/erlang/otp"><img
                    src="/assets/img/GitHub-Mark-32px.png" alt="Erlang/OTP on Github"></a>
        </div>
        
        <div>
            <a href="http://www.twitter.com/erlang_org"><img src="/assets/img/twitter.png"
                    width="32" alt="Erlang/OTP twitter"></a>
        </div>
    </footer>
    <script src="/assets/js/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>